<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Crop Ontology Trait Request Form</title>
    <link rel="stylesheet" href="static/css/pure-min.css">
    <link rel="stylesheet" href="static/css/grids-responsive-min.css">
    <style media="screen">
        .pure-button{
            border-radius: 4px;
        }
        .button-error {
            background: rgb(202, 60, 60);
            color: white;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }
        .remove-div {
            vertical-align: bottom;
            padding-bottom: 0.3em;
        }
        #add-category{
            margin-top: 0.3em;
        }
        #categorical-wrapper{
            margin-bottom: 1em;
        }
    </style>
</head>

<body>
    <div class="pure-g">
        <div class="pure-u-2-24"></div>
        <div class="pure-u-20-24">
            <h1>Crop Ontology Trait Request Form</h1>
            <form id="trait-form" class="pure-form pure-form-stacked">
                <fieldset>
                    <legend>Submitter Information</legend>
                    <div class="pure-g">
                        <div class="pure-u-1 pure-u-md-1-3">
                            <label for="name">Name</label>
                            <input name="name" id="name" class="pure-u-23-24" type="text" required>
                        </div>

                        <div class="pure-u-1 pure-u-md-1-3">
                            <label for="email">Email</label>
                            <input name="email" id="email" class="pure-u-23-24" type="email" required>
                        </div>

                        <div class="pure-u-1 pure-u-md-1-3">
                            <label for="program">Breeding Program</label>
                            <input name="program" id="program" class="pure-u-23-24" type="text" required>
                        </div>
                    </div>
                    <br><br>
                    <legend>Trait Information</legend>
                    <div class="pure-g">
                        <div class="pure-u-1 pure-u-md-1-3">
                            <label for="trait-name">Detailed Trait Name</label>
                            <input name="trait-name" id="trait-name" class="pure-u-23-24" type="text" required>
                        </div>
                        <div class="pure-u-1 pure-u-md-1-3">
                            <label for="crop-repo">Crop</label>
                            <select name="crop-repo" id="crop-repo" class="pure-u-23-24" required>
                                <option value="" disabled selected>Select crop...</option>
                            </select>
                        </div>
                        <div class="pure-u-1 pure-u-md-1-3">
                            <label for="trait-class">Trait Class</label>
                            <select name="trait-class" id="trait-class" class="pure-u-23-24" required>
                                <option value="" disabled selected>Select trait class...</option>
                                <option>Abiotic Stress</option>
                                <option>Argonomic</option>
                                <option>Biotic Stress</option>
                                <option>Morphological</option>
                                <option>Phenological</option>
                                <option>Physiological</option>
                                <option>Quality</option>
                            </select>
                        </div>
                        <!-- <div class="pure-u-1 pure-u-md-2-3"></div> -->
                        
                        <div class="pure-u-1 pure-u-md-3-3">
                            <label for="trait-def">Detailed Trait Definition</label>
                            <textarea id="trait-def" class="pure-u-23-24" name="trait-def" rows="4" required></textarea>
                        </div>
 
                        <div class="pure-u-1 pure-u-md-2-3">
                            <label for="method">Method of Measurement</label>
                            <input name="method" id="method" placeholder="e.g. 'visual rating of distribution of anthocyanin'" class="pure-u-23-24" type="text" required>
                        </div>
                        
                        <div class="pure-u-1 pure-u-md-2-3">
                            <label for="trait-type">Measurement Type</label>
                            <select name="trait-type" id="trait-type" class="pure-u-23-24" required>
                                <option value="" disabled selected>Select method type...</option>
                                <option value="Categorical">Categorical Measurement (e.g. [1,2,3,4,5] or [yellow, green, purple])</option>
                                <option value="Unit">Unit Measurement (e.g. kg)</option>
                            </select>
                        </div>
                    </div>
                    <div hidden showby="trait-type" showfor="Unit" id="unit-wrapper" class="pure-g">
                        <div class="pure-u-1 pure-u-md-2-3">
                            <label for="unit">Unit of Measurement</label>
                            <input name="unit" id="unit" class="pure-u-23-24" type="text" required>
                        </div>
                    </div>
                    <legend hidden showby="trait-type" showfor="Categorical" id="categorical-label">Categories</legend>
                    <div hidden showby="trait-type" showfor="Categorical" id="categorical-wrapper" class="pure-g">
                        <button name="add-category" id="add-category" type="button" class="pure-button">Add Category</button>
                        <input type="hidden" id="categories-count" value="0">
                    </div>
                    <button id="submit" type="button" class="pure-button pure-button-primary">Submit</button>
                </fieldset>
            </form>
        </div>
    </div>
    <div id="templates" hidden>
        <div class="pure-u-1 pure-g category">
            <div class="pure-u-1 pure-u-md-7-24">
                <label>Category</label>
                <input name="category-name" class="pure-u-23-24" type="text" required>
            </div>
            <div class="pure-u-1 pure-u-md-7-24">
                <label>Description</label>
                <input name="category-desc" class="pure-u-23-24" type="text" required>
            </div>
            <div class="remove-div pure-u-1 pure-u-md-7-24">
                <button type="button" class="remove-category pure-button button-error">X</button>
            </div>
        </div>
    </div>
    <script src="static/jquery-3.2.1.min.js" charset="utf-8"></script>
    <script type="text/javascript">
    var category_template = '#templates>.category';
    $.getJSON( "static/organism_repos.json", function( data ) {
        $(document).ready(function() { 
            $.each(data, function(key, value){
                var html = '<option value="'+value+'">'+key+'</option>';
                $(html).insertAfter("#crop-repo>option:last-of-type");
            });
        });
    });
    $(document).ready(function() { 
        $('#trait-type').change(function(){
            $('[showby="trait-type"][showfor]').attr("hidden", true);
            $('[showby="trait-type"][showfor="'+$(this).val()+'"]').attr("hidden", false);
        })
        $('#submit').click(function(){
            var $form = $('#trait-form');
            var filled = true;
            $form.find('input[type=text],input[type=email], textarea').filter("*:not([hidden],[hidden] *)").each(function() {
                if ( !$(this).val()){
                    alert("Please fill out all fields.");
                    console.log(this);
                    $(this).focus();
                    filled = false;
                    return false;
                }
            });
            if(!filled) return false;
            
            var valid = true;
            $form.find('fieldset *:invalid').filter("*:not([hidden],[hidden] *)").each(function(){
                alert("Invalid value.");
                console.log(this);
                $(this).focus();
                valid = false;
                return false;
            })
            if(!valid) return false;
            
            var cat_counter = $('#categories-count');
            if (cat_counter.is("*:not([hidden] *)") && parseInt(cat_counter.val())<2){
                alert("Must have at least 2 categories.");
                return false;
            }
            var form_array = $form.serializeArray();
            $form.find("input[type=text],input[type=email], textarea").val("");
            
            make_request(form_array);
        });
        $("#add-category").click(function() { 
            $('#categories-count').val( function(i, oldval) {
                return parseInt(oldval)+1;
            });
            console.log($('#categories-count').val());
            var newRow = $(category_template).clone(true).insertBefore("#add-category");
            newRow.find(".remove-category").click(function(){
                $('#categories-count').val( function(i, oldval) {
                    return parseInt(oldval)-1;
                });
                console.log($('#categories-count').val());
                newRow.remove();
                return false;
            });
            return false; 
        }); 
    });
    function make_request(form_array){
        var form = {};
        form_array.forEach(function(record){
            if (form[record.name]===undefined){
                form[record.name] = record.value;
            } else if (!Array.isArray(form[record.name])) {
                form[record.name] = [form[record.name]];
            } 
            if (Array.isArray(form[record.name])) {
                form[record.name].push(record.value);
            }
        });
        $.ajax({
            type: "POST",
            url: "/newIssue",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(form)
        });
    }
    if (!Array.isArray) {
      Array.isArray = function(arg) {
        return Object.prototype.toString.call(arg) === '[object Array]';
      };
    }
    </script>
</body>

</html>
